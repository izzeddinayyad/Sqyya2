# نظام إدارة السائقين الجديد

## نظرة عامة

تم تطوير نظام إدارة السائقين الجديد ليعمل بنظام "المصدر العام" حيث يمكن لصاحب المؤسسة تعيين سائقين متاحين لمؤسسته بدلاً من إنشاء حسابات جديدة.

## المبدأ الأساسي

### هيكل البيانات
- **جدول المستخدمين (users)**: يحتوي على جميع السائقين مع الحقول التالية:
  - `role = 'driver'` - لتحديد أن المستخدم سائق
  - `institution_id` - يربط السائق بمؤسسة معينة (أو `null` إذا كان متاحاً)

### منظور الرؤية
صاحب المؤسسة يرى في صفحة "إدارة السائقين" قائمتين:

1. **سائقو المؤسسة**: السائقون المرتبطون بمؤسسته (`institution_id = معرف_مؤسسته`)
2. **السائقون المتاحون**: سائقون غير مرتبطين بأي مؤسسة (`institution_id = null`)

## الوظائف المتاحة

### 1. عرض السائقين
- **سائقو المؤسسة**: يعرض السائقين المرتبطين بالمؤسسة مع معلومات الشاحنة المعينة
- **السائقون المتاحون**: يعرض السائقين غير المعينين مع تاريخ التسجيل

### 2. تعيين سائق للمؤسسة
- زر "تعيين للمؤسسة" بجانب السائقين المتاحين
- يحدث `institution_id` للسائق إلى معرف المؤسسة
- يختفي السائق من قائمة "المتاحين" لجميع المؤسسات الأخرى

### 3. فك تعيين سائق من المؤسسة
- زر "فك التعيين من المؤسسة" بجانب سائقي المؤسسة
- يعيد `institution_id` إلى `null`
- يظهر السائق في قائمة "المتاحين" لجميع المؤسسات

### 4. تعيين شاحنة للسائق
- زر "تعيين شاحنة" بجانب السائقين غير المعينين شاحنة
- يفتح modal لاختيار الشاحنة المتاحة
- يحدث `driver_id` في جدول الشاحنات

### 5. فك تعيين شاحنة من السائق
- زر "فك تعيين الشاحنة" بجانب السائقين المعينين شاحنة
- يعيد `driver_id` في جدول الشاحنات إلى `null`

## سير العمل

### تسجيل سائق جديد
1. السائق يدخل عبر صفحة التسجيل العامة
2. يختار "سائق" كدور
3. يتم إنشاء الحساب مع `institution_id = null`
4. يظهر في قائمة "السائقون المتاحون" لجميع المؤسسات

### تعيين سائق لمؤسسة
1. صاحب المؤسسة يدخل إلى "إدارة السائقين"
2. يشاهد قائمة "السائقون المتاحون"
3. يضغط "تعيين للمؤسسة" بجانب السائق المطلوب
4. يتم تحديث `institution_id` للسائق
5. ينتقل السائق إلى قائمة "سائقو المؤسسة"

### فك تعيين سائق من مؤسسة
1. صاحب المؤسسة يضغط "فك التعيين من المؤسسة"
2. يتم إعادة `institution_id` إلى `null`
3. ينتقل السائق إلى قائمة "السائقون المتاحون"

## المميزات

### 1. عزل البيانات
- كل مؤسسة ترى فقط سائقيها والسائقين المتاحين
- لا يمكن رؤية سائقين من مؤسسات أخرى

### 2. المرونة
- يمكن فك تعيين السائقين وإعادة تعيينهم
- لا حاجة لحذف الحسابات

### 3. الشفافية
- عرض واضح لحالة كل سائق
- معلومات مفصلة عن الشاحنات المعينة

### 4. الأمان
- التحقق من الصلاحيات عبر middleware
- تأكيد العمليات الحساسة

## الملفات المحدثة

### Controllers
- `OrganizationController.php`: إضافة methods جديدة لإدارة السائقين

### Views
- `drivers_management.blade.php`: واجهة جديدة لإدارة السائقين
- `sidebar.blade.php`: تحديث رابط إدارة السائقين

### Routes
- `web.php`: إضافة routes جديدة للنظام الجديد

### Models
- `User.php`: العلاقات مع الشاحنات والمؤسسات
- `Truck.php`: العلاقات مع السائقين والمؤسسات

### Database
- Migrations: تأكد من وجود جميع الحقول المطلوبة
- Seeders: بيانات اختبار للنظام الجديد

## الاستخدام

### تسجيل الدخول كصاحب مؤسسة
```
البريد: ahmed@institution1.com
كلمة المرور: password
```

### الوصول لإدارة السائقين
1. تسجيل الدخول كصاحب مؤسسة
2. الضغط على "إدارة السائقين" في القائمة الجانبية
3. مشاهدة القائمتين: سائقو المؤسسة والسائقون المتاحون

### اختبار الوظائف
1. **تعيين سائق متاح**: الضغط على "تعيين للمؤسسة"
2. **تعيين شاحنة**: الضغط على "تعيين شاحنة" بجانب سائق غير معين شاحنة
3. **فك التعيين**: الضغط على "فك التعيين من المؤسسة" أو "فك تعيين الشاحنة"

## البيانات التجريبية

تم إنشاء بيانات اختبار تشمل:
- مؤسستين مع سائقين مرتبطين
- 3 سائقين متاحين للتعيين
- شاحنات معينة وغير معينة
- مندوبين لكل مؤسسة

## الأمان والصلاحيات

- **Middleware**: `checkrole:org_owner` للتحقق من دور المستخدم
- **Middleware**: `institution.access` للتحقق من صلاحيات الوصول
- **Validation**: التحقق من صحة البيانات المدخلة
- **Confirmation**: تأكيد العمليات الحساسة قبل التنفيذ 